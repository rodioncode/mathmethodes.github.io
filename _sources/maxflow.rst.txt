.. _maxflow:

Задача о максимальном потоке
=========================================================================================

.. toctree::
   :maxdepth: 2


Постановка задачи о максимальном потоке
---------------------------------------

Задача о максимальном потоке заключается в нахождении такого потока по
транспортной сети, что сумма потоков из истока, или, что то же самое,
сумма потоков в сток максимальна.

Рассмотрим сеть, имеющую только один источник s и только один сток t.
Рассмотрим задачу о потоке из узла s в узел t, причем s и t могут быть
связаны произвольно сложной промежуточной сетью. Задача о максимальном
потоке состоит в определении количества, которое можно перевезти из s в
t.

| Эту задачу можно проиллюстировать, как водопроводную или нефтяную
  сеть. Рассмотрим сеть трубопроводов для транспортировки сырой нефти от
  буровых скважин до нефтеперегонных заводов. Для перекачки нефти
  предусмотрены магистральные насосные станции. Каждый сегмент
  трубопровода имеет свою пропускную способность. Сегменты трубопровода
  могут быть как однонаправленные (осуществляют перекачку нефти только в
  одном направлении), так и в двунаправленные. В однонаправленных
  сегментах положительная пропускная способность предполагается в одном
  направлении и нулевая - в другом. На Рисунке 1 показана типовая сеть
  нефтепроводов. Как определить оптимальную пропускную способность (т.е.
  максимальный поток) между нефтяными скважинами и нефтеперегонными
  заводами?

.. figure::  pictures/37.png
   :align:   center

   Рисунок 1

Основные понятия
----------------

Сетью (flow network) называется ориентированный граф, каждому ребру
(i,j) которого сопоставлено неотрицательное число C(i,j), называемое
пропускной способностью, с двумя выделенными вершинами, называемыми
исток s (source) и сток t (sink).

Необходимо знать следующие правила для решения задачи.

1. Будем считать, что если поток из вершины i к j равен
:math:`\varphi_{ij}`, то противоположный поток равен
-:math:`\varphi_{ij}`.

2. Если поток по дуге :math:`\varphi_{ij}` меньше его пропускной
способности, то есть :math:`\varphi_{ij}<C_{ij}`, то дуга называется
ненасыщенной потоком, если же :math:`\varphi_{ij}=C_{ij}`, то дуга
называется насыщенной потоком.

3. Из физического смысла грузопотока следует, что поток по каждой дуге
не может превышать ее пропускную способность, т.е.
:math:`\varphi_{ij} \leq C_{ij}`.

4. Для любой вершины, кроме источника и стока, количество вещества,
поступающего в эту вершину, равно количеству вещества, вытекающего из
него. Это условие называется условием сохранения потока, в промежуточных
вершинах потоки не создаются и не исчезают – отсюда следует, что общее
количество вещества, вытекающего из источника, совпадает с общим
количеством вещества, поступающего в сток.

| Для ребра (i,j), где i<j, используем запись (:math:`C_{ij},C_{ji}`)
  для представления пропускных способностей в направлениях
  i\ :math:`\to`\ j и j\ :math:`\to`\ i соответственно. Во избежании
  недоразумений на схеме сети :math:`C_{ij}` будем располагать на ребре
  (i,j) ближе к узлу i, а :math:`C_{ji}` ближе к узлу j, как показано на
  Рисунок 2.

.. figure::  pictures/35.png
   :align:   center

   Рисунок 2

Разрез
------

Разрез определяет множество ребер, при удалении которых из сети
полностью прекращается поток от источника к столу. Пропускная
способность разреза равна сумме пропускных способностей разрезанных
ребер. Среди всех разрезов сети разрез с минимальной пропускной
способностью определяет максимальный поток в сети.

**Пример:**

| Рассмотрим сеть, показанную на Рисунке 3. На этом рисунке при
  обозначении пропускных способностей двунаправленных ребер
  придерживались соглашения, принятого ранее. Например, для ребра (3, 4)
  пропускная способность в направлении 3\ :math:`\to`\ 4 равна 10, а в
  направлении 4\ :math:`\to`\ 3 равна 5.

.. figure::  pictures/36.png
   :align:   center

   Рисунок 3

Разрезы, представленные на Рисунке 3, имеют следующие пропускные
способности:

.. raw:: latex

   \centering

+--------+--------------------------------+-------------------------+
| Разрез | "Разрезанные" ребра            | Пропускная способность  |
+========+================================+=========================+
| 1      | (1, 2), (1, 3), (1, 4)         | 10 + 30 + 20 = 60       |
+--------+--------------------------------+-------------------------+
| 2      | (1, 3), (1, 4), (2, 3), (2, 5) | 30 + 10 + 40 + 30 = 110 |
+--------+--------------------------------+-------------------------+
| 3      | (2, 5), (3, 5), (4, 5)         | 30 + 20 + 20 = 70       |
+--------+--------------------------------+-------------------------+

Вывод, который можно сделать из этих трех разрезов, заключается в том,
что максимальный поток не может превышать 60 единиц. Но мы не можем
сказать, какой максимальный поток на самом деле, так как не перебрали
все возможные разрезы сети. К сожалению, перебор всех разрезов является
непростой задачей. Поэтому для определения максимального потока в сети
не используются алгоритмы, основанные на полном переборе разрезов.

Алгоритм Форда-Фалкерсона нахождения максимального потока
---------------------------------------------------------

#. Обнуляем все потоки.

#. В сети находим любой путь из источника в сток. Если такого пути нет,
   останавливаемся.

#. Пускаем через найденный путь максимально возможный поток:

   #. На найденном пути в остаточной сети ищем ребро с минимальной
      пропускной способностью :math:`C_{min}`. (:math:`\beta`\ =min
      :math:`C_{ij}`>0)

   #. Для каждого ребра на найденном пути увеличиваем поток на
      :math:`C_{min}`, а в противоположном ему — уменьшаем на
      :math:`C_{min}`.
      (:math:`\varphi_{ij}`\ =\ :math:`\varphi_{ij} \pm C_{min}`)

   #. Модифицируем остаточную сеть. Для всех рёбер на найденном пути, а
      также для противоположных им рёбер, вычисляем новую пропускную
      способность. Если она стала ненулевой, добавляем ребро к
      остаточной сети, а если обнулилась, стираем его.
      (:math:`C_{ij}`\ =\ :math:`C_{ij}`-:math:`C_{min}`)

#. Возвращаемся на шаг 2.

Величина максимального потока в транспортной сети T равна минимальной из
пропускных способностей его сечений.

:math:`\varphi_{max}=\varphi_{max}+C_{ij}`

Практическое применение максимального потока
--------------------------------------------

Пример решения типовой задачи с помощью максимального потока
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

**Пример:**

Рассмотрим транспортную сеть T, пусть :math:`\varphi_0` - нулевой поток.

.. figure::  pictures/28.png
   :align:   center

   Рисунок 4

Нашли путь (обозначен красным цветом)

.. figure::  pictures/29.png
   :align:   center

   Рисунок 5

:math:`P_1`\ =s(s,a)a(a,b)b(b,d)d(d,t)t.

| Тогда :math:`\beta`\ =min :math:`C_{ij}`\ =min(5, 4, 5, 5)=4, и поток
  :math:`\varphi_{max}`\ =4.
| Дуга (a,b) - насыщенная
  :math:`C_{ij}`\ =\ :math:`C_{ij}`-:math:`C_{min}`\ =4-4=0, поэтому мы
  ее вычеркиваем. Вычисляем пропускную способность и увеличиваем поток
  для каждого ребра.

.. figure::  pictures/30.png
   :align:   center

   Рисунок 6

Нашли новый путь (обозначен синим цветом)

.. figure::  pictures/31.png
   :align:   center

   Рисунок 7

:math:`P_2`\ =s(s,b)b(b,d)d(d,t)t.

| Тогда :math:`\beta`\ =min :math:`C_{ij}`\ =min(3, 1, 1, 1)=1, и поток
  :math:`\varphi_{max}`\ =4+1=5.
| Дуги (b,d), (d,t) - насыщенные
  :math:`C_{ij}`\ =\ :math:`C_{ij}`-:math:`C_{min}`\ =1-1=0, поэтому мы
  их вычеркиваем. Вычисляем пропускную способность и увеличиваем поток
  для каждого ребра.

.. figure::  pictures/32.png
   :align:   center

   Рисунок 8

Нашли еще один путь (обозначен зеленым цветом)

.. figure::  pictures/33.png
   :align:   center

   Рисунок 9

:math:`P_3`\ =s(s,a)a(a,b)c(c,t)t.

| Тогда :math:`\beta`\ =min :math:`C_{ij}`\ =min(1, 2, 7)=1, и поток
  :math:`\varphi_{max}`\ =5+1=6.
| Дуга (s,a) - насыщенная
  :math:`C_{ij}`\ =\ :math:`C_{ij}`-:math:`C_{min}`\ =1-1=0, поэтому мы
  ее вычеркиваем. Вычисляем пропускную способность и увеличиваем поток
  для каждого ребра.

.. figure::  pictures/34.png
   :align:   center

   Рисунок 10

| Как видно путей из источника в сток не осталось, значит задача
  завершена.
| Получаем, что максимальный поток :math:`\varphi_{max}`\ =6, так же
  соблюдается закон сохранения вещества - общее количество вещества,
  вытекающего из источника, совпадает с общим количеством вещества,
  поступающего в сток.

**Oтвет:** :math:`\varphi_{max}`\ =6.

Перейти к практике
-------------------
`Посмотреть примеры и решить задачу <http://en.wikipedia.org/wiki/Hyperlink>`_